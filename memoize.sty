\ProvidesPackage{memoize}
\RequirePackage{pgfkeys}
\RequirePackage{etoolbox}
\RequirePackage{graphicx}

\def\memoizeset#1{\pgfqkeys{/memoize}{#1}}
\memoizeset{%
  copy command/.store in=\memoizeCopyCommand,
  memoize jobname/.store in=\memoizeJobname,
  split jobname prefix/.store in=\memoizeSplitJobnamePrefix,
  system call/.store in=\memoizeSystemCall,
}
\def\memoizeCopyCommand{}
%\def\memoizeCopyCommand{cp "\source" "\target"}
\def\memoizeJobname{\jobname}
\def\memoizeSplitJobnamePrefix{\jobname.mmz.}
\def\memoizeSystemCall{pdflatex -halt-on-error -interaction=batchmode
    -jobname "\detokenize\expandafter{\mmz@syscall@jobname}" "\detokenize\expandafter{\mmz@syscall@commands}"}

\newwrite\mmz@out
\newbox\mmz@box

\def\memoize#1{%
  \edef\mmz@id{\expandafter\pdfmdfivesum\expandafter{\detokenize{#1}}}%
  \mmz@use@memoized@or{%
    \PackageInfo{memoize}{Memoizing \mmz@id\space on input line \the\inputlineno}%
    \setbox\mmz@box=\hbox{#1}%
    \mmz@eject\mmz@box
    \immediate\write\mmz@out{%
      \noexpand\memoized{\mmz@id}{\memoizeJobname}{\the\mmz@realpage}{\the\dp\mmz@box}%
    }%
  }%
  \leavevmode\box\mmz@box
}

\def\mmz@use@memoized@or{%
  \undef\mmz@filename
  \@input{\memoizeSplitJobnamePrefix\mmz@id}%
  \ifdef\mmz@filename{%
    \IfFileExists{\memoizeSplitJobnamePrefix\mmz@id.pdf}{%
      \edef\mmz@marshal{%
        \noexpand\includegraphics[page=\mmz@page]{\mmz@filename.pdf}%
      }%
      \PackageInfo{memoize}{Using \mmz@id\space on input line \the\inputlineno}%
      \setbox\mmz@box=\hbox{\lower\mmz@dp\hbox{\mmz@marshal}}%
      \@gobble
    }{\@firstofone}}{\@firstofone}%
}

\def\mmz@eject#1{%
  {% Leave it all to pdftex ... manual 8.1: \pgfpagewidth
    \pdfpagewidth0pt
    \pdfpageheight 0pt
    \pdfhorigin 0pt
    \pdfvorigin 0pt
    \hoffset 0pt
    \voffset 0pt
    \shipout\copy#1%
  }%
}

\let\mmz@orig@shipout\shipout
\newcount\mmz@realpage
\def\shipout{%
  \global\advance\mmz@realpage1
  \mmz@orig@shipout
}

\def\memoized#1#2#3#4{%
  \csdef{mmz@@#1}{%
    \def\mmz@filename{#2}%
    \def\mmz@page{#3}%
    \def\mmz@dp{#4}%
  }%
  \edef\mmz@syscall@jobname{\memoizeSplitJobnamePrefix#1}%
  \def\mmz@syscall@commands{\documentclass{standalone}\usepackage{graphicx}\begin{document}\includegraphics[page=#3]{#2}\end{document}}%
  \immediate\write18{\memoizeSystemCall}%
  \immediate\openout\mmz@out=\mmz@syscall@jobname
  \immediate\write\mmz@out{\noexpand\memoized{#1}{\mmz@syscall@jobname}{1}{#4}}%
  \immediate\closeout\mmz@out
}
\@input{\jobname.mmz}%
\def\memoized#1#2#3#4{%
  \expandafter\ifstrequal\expandafter{\mmz@id}{#1}{}{%
    \PackageWarning{memoize}{mmz id mismatch: stored "\mmz@temp"\space does not equal the caller "\mmz@id". How did this happen?}%
  }%
  \def\mmz@filename{#2}%
  \def\mmz@page{#3}%
  \def\mmz@dp{#4}%
}

\AtBeginDocument{\immediate\openout\mmz@out=\jobname.mmz}
\AtEndDocument{\immediate\closeout\mmz@out}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "test1"
%%% End:
