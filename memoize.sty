\ProvidesPackage{memoize}
\RequirePackage{pgfkeys}
\RequirePackage{etoolbox}

\def\memoizeset#1{\pgfqkeys{/memoize}{#1}}
\memoizeset{%
  copy command/.store in=\memoizeCopyCommand,
  memoize jobname/.store in=\memoizeJobname,
  split jobname prefix/.store in=\memoizeSplitJobnamePrefix,
  pdflatex system call/.store in=\memoizePdfLaTeXSystemCall,
  pdftex system call/.store in=\memoizePdfTeXSystemCall,
}
\def\memoizeCopyCommand{}
%\def\memoizeCopyCommand{cp "\source" "\target"}
\def\memoizeJobname{\jobname}
\def\memoizeSplitJobnamePrefix{\jobname.mmz.}
\def\memoizePdfLaTexSystemCall{pdflatex -halt-on-error -interaction=batchmode
    -jobname "\detokenize\expandafter{\mmz@syscall@jobname}" "\detokenize\expandafter{\mmz@syscall@commands}"}
\def\memoizePdfTeXSystemCall{pdftex -halt-on-error -interaction=batchmode
  -jobname "\detokenize\expandafter{\mmz@syscall@jobname}" "\detokenize\expandafter{\mmz@syscall@commands}"}

\newwrite\mmz@out
\newbox\mmz@box

\def\memoize#1{%
  \edef\mmz@id{\expandafter\pdfmdfivesum\expandafter{\detokenize{#1}}}%
  \mmz@use@memoized@or{%
    \PackageInfo{memoize}{Memoizing \mmz@id\space on input line \the\inputlineno}%
    \setbox\mmz@box=\hbox{#1}%
    {%
      \mmz@eject{\copy\mmz@box}%
    }%
    \immediate\write\mmz@out{%
      \noexpand\memoized{\mmz@id}{\memoizeJobname}{\the\mmz@realpage}{\the\dp\mmz@box}%
    }%
  }%
  % \quitvmode is pdftex's replacement for \leavevmode (8.21)
  \quitvmode\box\mmz@box
}

\def\mmz@use@memoized@or{%
  \undef\mmz@filename
  \@input{\memoizeSplitJobnamePrefix\mmz@id}%
  \ifdef\mmz@filename{%
    \IfFileExists{\memoizeSplitJobnamePrefix\mmz@id.pdf}{%
      \pdfximage {\mmz@filename.pdf}%
      \PackageInfo{memoize}{Using \mmz@id\space on input line \the\inputlineno}%
      \setbox\mmz@box=\hbox{\lower\mmz@dp\hbox{\pdfrefximage \pdflastximage}}%
      \@gobble
    }{\@firstofone}}{\@firstofone}%
}

\def\mmz@eject#1{%
  % Leave it all to pdftex ... manual 8.1: \pgfpagewidth
  \pdfpagewidth 0pt
  \pdfpageheight 0pt
  \pdfhorigin 0pt
  \pdfvorigin 0pt
  \hoffset 0pt
  \voffset 0pt
  \shipout#1%
}

\let\mmz@orig@shipout\shipout
\newcount\mmz@realpage
\def\shipout{%
  \global\advance\mmz@realpage1
  \mmz@orig@shipout
}

\def\memoized#1#2#3#4{%
  \csdef{mmz@@#1}{%
    \def\mmz@filename{#2}%
    \def\mmz@page{#3}%
    \def\mmz@dp{#4}%
  }%
  \edef\mmz@syscall@jobname{\memoizeSplitJobnamePrefix#1}%
  \expandafter\def\expandafter\mmz@syscall@commands\expandafter{%
    \mmz@eject{\box0}\end}%
  \preto\mmz@syscall@commands{%
    \pdfximage page #3 {#2.pdf}%
    \setbox0=\hbox{\pdfrefximage \pdflastximage}%
  }%
  \immediate\write18{\memoizePdfTeXSystemCall}%
  \immediate\openout\mmz@out=\mmz@syscall@jobname
  \immediate\write\mmz@out{\noexpand\memoized{#1}{\mmz@syscall@jobname}{1}{#4}}%
  \immediate\closeout\mmz@out
}
\@input{\jobname.mmz}%
\def\memoized#1#2#3#4{%
  \expandafter\ifstrequal\expandafter{\mmz@id}{#1}{}{%
    \PackageWarning{memoize}{mmz id mismatch: stored "\mmz@temp"\space does not equal the caller "\mmz@id". How did this happen?}%
  }%
  \def\mmz@filename{#2}%
  \def\mmz@page{#3}%
  \def\mmz@dp{#4}%
}

\AtBeginDocument{\immediate\openout\mmz@out=\jobname.mmz}
\AtEndDocument{\immediate\closeout\mmz@out}

% ideas:
% - could \pdfdraftmode be useful?
% - ditto for \pdflastximagepages

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "test1"
%%% End:
